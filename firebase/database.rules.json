{
  "rules": {
    "quizzes": {
      "$quizId": {
        ".read": "auth != null",
        ".write": "auth != null && (!data.exists() || auth.uid === data.child('config/hostId').val())",
        "config": {
          ".write": "auth != null && (!data.parent().exists() ? newData.child('hostId').val() === auth.uid : auth.uid === data.child('hostId').val())",
          "hostId": {
            ".write": "auth != null && auth.uid === newData.val()",
            ".validate": "newData.isString() && newData.val() === auth.uid"
          },
          "status": {
            ".write": "auth != null && auth.uid === root.child('quizzes/' + $quizId + '/config/hostId').val()",
            ".validate": "newData.isString() && (newData.val() === 'waiting' || newData.val() === 'inProgress' || newData.val() === 'finished')"
          },
          "questionDuration": {
            ".write": "auth != null && auth.uid === root.child('quizzes/' + $quizId + '/config/hostId').val()",
            ".validate": "newData.isNumber() && newData.val() >= 5 && newData.val() <= 60"
          }
        },
        "gameState": {
          ".write": "auth != null && auth.uid === root.child('quizzes/' + $quizId + '/config/hostId').val()",
          "currentQuestionIndex": {
            ".validate": "newData.isNumber() && newData.val() >= -1"
          },
          "questionStartedAt": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          }
        },
        "questions": {
          ".write": "auth != null && auth.uid === root.child('quizzes/' + $quizId + '/config/hostId').val()",
          "$index": {
            ".validate": "newData.hasChildren(['text', 'options', 'correctIndex'])"
          }
        }
      }
    },
    "participants": {
      "$quizId": {
        ".read": "auth != null && root.child('quizzes/' + $quizId).exists()",
        "$uid": {
          ".read": "auth != null && root.child('quizzes/' + $quizId).exists()",
          ".write": "auth != null && auth.uid === $uid && (!data.exists() ? (newData.child('score').val() === 0) : (newData.child('score').val() === data.child('score').val()))",
          "name": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 20"
          },
          "score": {
            ".write": "auth != null && auth.uid === root.child('quizzes/' + $quizId + '/config/hostId').val()",
            ".validate": "newData.isNumber() && newData.val() >= 0"
          }
        }
      }
    },
    "answers": {
      "$quizId": {
        "$questionIndex": {
          ".read": "auth != null && auth.uid === root.child('quizzes/' + $quizId + '/config/hostId').val()",
          "$uid": {
            ".read": "auth != null && auth.uid === $uid",
            ".write": "auth != null && auth.uid === $uid && !data.exists() && root.child('quizzes/' + $quizId + '/config/status').val() === 'inProgress' && root.child('quizzes/' + $quizId + '/gameState/currentQuestionIndex').val() + '' === $questionIndex",
            ".validate": "newData.hasChildren(['questionIndex', 'selectedOptionIndex', 'answeredAt']) && newData.child('questionIndex').val() + '' === $questionIndex && newData.child('selectedOptionIndex').isNumber() && newData.child('selectedOptionIndex').val() >= 0 && newData.child('selectedOptionIndex').val() <= 3 && newData.child('answeredAt').isNumber()"
          }
        }
      }
    },
    "pointsAwarded": {
      "$quizId": {
        "$questionIndex": {
          "$uid": {
            ".read": "auth != null && auth.uid === root.child('quizzes/' + $quizId + '/config/hostId').val()",
            ".write": "auth != null && auth.uid === root.child('quizzes/' + $quizId + '/config/hostId').val() && (!data.exists())",
            ".validate": "newData.isNumber() && newData.val() >= 0"
          }
        }
      }
    }
  }
}